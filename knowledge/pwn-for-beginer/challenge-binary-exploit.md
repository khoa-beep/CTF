# Challenge Binary exploit

* **Category:** PWN
* **Points:** No

## Challenge

Narnia Level 0 → Level 1

## Solution

Source CODE

```c
#include <stdio.h>
#include <stdlib.h>

int main(){
    long val=0x41414141;
    char buf[20];

    printf("Correct val's value from 0x41414141 -> 0xdeadbeef!\n");
    printf("Here is your chance: ");
    scanf("%24s",&buf);

    printf("buf: %s\n",buf);
    printf("val: 0x%08x\n",val);

    if(val==0xdeadbeef){
        setreuid(geteuid(),geteuid());
        system("/bin/sh");
    }
    else {
        printf("WAY OFF!!!!\n");
        exit(1);
    }

    return 0;
}
```

### Phân tích đề

```c
    long val=0x41414141;
    char buf[20];     
```

Ở đây chúng ta thấy hai biến đang được tạo, biến val được khởi tạo thành giá trị hex 0x41414141 và buf là một mảng không được khởi tạo thành bất kỳ giá trị nào, nhưng không gian đã được dành cho 20 phần tử 1 byte. Kiểu dữ liệu “char” trong C được định nghĩa là có độ dài 1 byte, do đó char buf \[20] dự trữ 20 vị trí bộ nhớ 1 byte liên tiếp.

```c
    printf("Correct val's value from 0x41414141 -> 0xdeadbeef!\n");
    printf("Here is your chance: ");
```

Biến val, đã được khởi tạo thành giá trị 0x41414141, chương trình muốn bạn thay đổi bằng cách nào đó thành giá trị 0xdeadbeef để đi đến flag.

```c
  scanf("%24s",&buf);
```

Hàm scanf được sử dụng để nhập dữ liệu của người dùng. % 24s có nghĩa là hàm sẽ chấp nhận một chuỗi ký tự 24 byte (1 char = 1 byte) và lưu trữ chuỗi đó vào biến buf, nhưng nếu bạn nhớ thì buf chỉ được cấp phát 20 byte bộ nhớ. Đây là cách ta sẽ khai thác chương trình.

## Note

Nếu mình ghi đè chính xác vị trí bộ nhớ của biến val để giữ 0xdeadbeef, thì câu lệnh phân nhánh này sẽ cung cấp cho bạn một flag . Nếu không, nó sẽ in “WAY OFF !!!!” và sau đó thoát ra. Đừng thất vọng, không quan trọng bạn ở gần đến mức nào, nó sẽ luôn in ra câu nói này nếu nó không chính xác.

## Ta cần hiểu cách hoạt động Stack khi thực thi Call

Visit https://whiteheart0.medium.com/0x00-basics-of-reverse-engineering-stack-99bebf865359

```python
      Stack main
    |            |
    |  BUFF [20] |
    |     VAL    |
    |------------|
    |------------|
    |   Old EBP  |
    |   RET ADD  |
```

Vì ngăn xếp phát triển từ bộ nhớ cao đến bộ nhớ thấp, val được lưu trữ ở địa chỉ bộ nhớ cao hơn buf , vì val được khai báo đầu tiên trong chương trình.

Vì thử thách này chỉ yêu cầu chúng ta thao tác buf và val.

## Vậy ta sẽ giải quyết ra sao

Theo như trên ta cần ghi đủ 20 bye trên vùng buff cộng thêm thay thế 4 byte của địa chỉ giá trị của biến value cần kiểm tra là 0xdeadbeef là ta sẽ ra win.

## Payload

```python
python -c 'python "A"*20 + '\xef\xbe\xad\xde''.filename
```

```
The flag : efeidiedae
```

Mật khẩu của cấp độ tiếp theo.
